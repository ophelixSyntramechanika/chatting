<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SIGNAL ‚Äî Chat</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap"
        rel="stylesheet" />
    <style>
        :root {
            --bg: #080810;
            --surface: #0e0e1c;
            --border: #1e1e3a;
            --accent: #00f5a0;
            --accent2: #00c8ff;
            --danger: #ff4d6d;
            --text: #e8e8f0;
            --muted: #555570;
            --me-bg: #0a2a1f;
            --them-bg: #0a0a22;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        /* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
        #setupScreen {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            padding: 20px;
        }

        .setup-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
        }

        .setup-box h1 {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        .setup-box h1 span {
            color: var(--accent);
        }

        .setup-box p {
            color: var(--muted);
            font-size: 0.8rem;
            margin-bottom: 30px;
            font-family: 'Space Mono', monospace;
        }

        .field {
            margin-bottom: 16px;
        }

        .field label {
            display: block;
            font-size: 0.68rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .field input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            padding: 13px 16px;
            font-size: 0.95rem;
            font-family: 'Syne', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .field input:focus {
            border-color: var(--accent);
        }

        .btn-primary {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 1rem;
            font-weight: 800;
            font-family: 'Syne', sans-serif;
            cursor: pointer;
            letter-spacing: 2px;
            transition: opacity 0.2s, transform 0.1s;
            margin-top: 6px;
        }

        .btn-primary:hover {
            opacity: 0.85;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        #setupError {
            color: var(--danger);
            font-size: 0.78rem;
            margin-top: 12px;
            font-family: 'Space Mono', monospace;
            display: none;
            text-align: center;
        }

        /* ‚îÄ‚îÄ CHAT SCREEN ‚îÄ‚îÄ */
        #chatScreen {
            display: none;
            flex-direction: column;
            height: 100dvh;
            position: relative;
            z-index: 1;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(8, 8, 16, 0.92);
            backdrop-filter: blur(12px);
            flex-shrink: 0;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: 4px;
            color: var(--accent);
        }

        .room-tag {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            color: var(--muted);
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 3px 10px;
            border-radius: 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.72rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.3;
                transform: scale(0.7);
            }
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.72rem;
            font-family: 'Space Mono', monospace;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-icon:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Storage info bar */
        #storageBar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 6px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            flex-shrink: 0;
        }

        #storageBar span {
            color: var(--accent2);
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scroll-behavior: smooth;
        }

        #messages::-webkit-scrollbar {
            width: 3px;
        }

        #messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .msg-wrap {
            display: flex;
            flex-direction: column;
            animation: fadeUp 0.18s ease;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-wrap.me {
            align-items: flex-end;
        }

        .msg-wrap.them {
            align-items: flex-start;
        }

        .msg-wrap.system {
            align-items: center;
        }

        .msg-meta {
            font-size: 0.62rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            margin-bottom: 3px;
            padding: 0 4px;
        }

        .bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.9rem;
            line-height: 1.5;
            word-break: break-word;
        }

        .msg-wrap.me .bubble {
            background: var(--me-bg);
            border: 1px solid #1a4a30;
            border-bottom-right-radius: 4px;
            color: var(--accent);
        }

        .msg-wrap.them .bubble {
            background: var(--them-bg);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
            color: var(--text);
        }

        .msg-wrap.system .bubble {
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 0.7rem;
            font-family: 'Space Mono', monospace;
            font-style: italic;
            padding: 4px;
        }

        .input-bar {
            display: flex;
            gap: 10px;
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            background: rgba(8, 8, 16, 0.92);
            backdrop-filter: blur(12px);
            flex-shrink: 0;
        }

        #msgInput {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            padding: 12px 16px;
            font-size: 0.9rem;
            font-family: 'Syne', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        #msgInput:focus {
            border-color: var(--accent);
        }

        .btn-send {
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 10px;
            padding: 12px 22px;
            font-size: 0.9rem;
            font-weight: 800;
            font-family: 'Syne', sans-serif;
            cursor: pointer;
            transition: opacity 0.2s;
            letter-spacing: 1px;
        }

        .btn-send:hover {
            opacity: 0.8;
        }
    </style>
</head>

<body>

    <!-- ‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê -->
    <div id="setupScreen">
        <div class="setup-box">
            <h1>SIGNAL<span>.</span></h1>
            <p>// instant encrypted chat</p>

            <div class="field">
                <label>Room Name</label>
                <input type="text" id="roomInput" placeholder="e.g. secret-room-42" value="general" />
            </div>

            <div class="field">
                <label>Your Username</label>
                <input type="text" id="nameInput" placeholder="e.g. ghost" maxlength="20" />
            </div>

            <button class="btn-primary" onclick="startChat()">ENTER ROOM ‚Üí</button>
            <div id="setupError"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê CHAT SCREEN ‚ïê‚ïê -->
    <div id="chatScreen">
        <header>
            <div class="header-left">
                <div class="logo">SIGNAL</div>
                <div class="room-tag" id="roomTag">#general</div>
            </div>
            <div class="header-right">
                <div class="online-pill">
                    <div class="pulse"></div>
                    <span id="onlineCount">...</span>
                </div>
                <button class="btn-icon" onclick="clearChat()">üóë clear</button>
                <button class="btn-icon" onclick="leaveChat()">‚úï leave</button>
            </div>
        </header>

        <!-- Storage info bar -->
        <div id="storageBar">
            üíæ messages: <span id="msgCount">0</span> / 100 &nbsp;|&nbsp;
            üïê auto-delete after: <span>24 hours</span> &nbsp;|&nbsp;
            üì¶ keeping storage clean automatically
        </div>

        <div id="messages"></div>

        <div class="input-bar">
            <input type="text" id="msgInput" placeholder="type a message and hit enter..."
                onkeydown="if(event.key==='Enter') { sendMsg(); event.preventDefault(); }" />
            <button class="btn-send" onclick="sendMsg()">SEND</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getDatabase, ref, push, onChildAdded, onValue,
            set, remove, get, query, orderByChild,
            limitToFirst, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // ‚îÄ‚îÄ FIREBASE CONFIG ‚îÄ‚îÄ
        const firebaseConfig = {
            apiKey: "AIzaSyDhdlUOQ4QswwmmBRW3qmuE4zdXBjZwb6M",
            authDomain: "peertopeer-8c05f.firebaseapp.com",
            databaseURL: "https://peertopeer-8c05f-default-rtdb.firebaseio.com",
            projectId: "peertopeer-8c05f",
            storageBucket: "peertopeer-8c05f.firebasestorage.app",
            messagingSenderId: "499073961493",
            appId: "1:499073961493:web:821f3f85d50c381287481c"
        };

        const MAX_MESSAGES = 100;          // max messages kept per room
        const MAX_AGE_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myName = "";
        let myRoom = "";
        let messagesRef, presenceRef;

        // ‚îÄ‚îÄ START CHAT ‚îÄ‚îÄ
        window.startChat = function () {
            myName = document.getElementById("nameInput").value.trim();
            myRoom = document.getElementById("roomInput").value.trim()
                .toLowerCase().replace(/\s+/g, "-") || "general";

            if (!myName) { showErr("Please enter a username"); return; }

            messagesRef = ref(db, `rooms/${myRoom}/messages`);
            presenceRef = ref(db, `rooms/${myRoom}/presence/${myName}`);

            // Mark online, auto-remove on disconnect
            set(presenceRef, { name: myName, online: true });

            // Count online users
            onValue(ref(db, `rooms/${myRoom}/presence`), snap => {
                const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                document.getElementById("onlineCount").textContent = count + " online";
            });

            // Clean up old messages when joining
            cleanupMessages();

            // Listen for new messages (only last 100)
            const recentQuery = query(messagesRef, orderByChild("time"), limitToFirst(MAX_MESSAGES));
            onChildAdded(recentQuery, snap => {
                const m = snap.val();
                if (m) renderBubble(m.name, m.text, m.name === myName ? "me" : "them", m.time);
            });

            // Track message count
            onValue(messagesRef, snap => {
                const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                document.getElementById("msgCount").textContent = count;

                // Auto-purge if over limit
                if (count > MAX_MESSAGES) purgeOldest(count - MAX_MESSAGES);
            });

            // Show chat
            document.getElementById("setupScreen").style.display = "none";
            document.getElementById("chatScreen").style.display = "flex";
            document.getElementById("roomTag").textContent = "#" + myRoom;
            document.getElementById("msgInput").focus();
            addSystem(`you joined #${myRoom} as ${myName}`);
        };

        // ‚îÄ‚îÄ SEND MESSAGE ‚îÄ‚îÄ
        window.sendMsg = function () {
            const input = document.getElementById("msgInput");
            const text = input.value.trim();
            if (!text || !messagesRef) return;

            push(messagesRef, {
                name: myName,
                text: text,
                time: Date.now()   // timestamp for age-based cleanup
            });

            input.value = "";
        };

        // ‚îÄ‚îÄ CLEAR CHAT (manual) ‚îÄ‚îÄ
        window.clearChat = function () {
            if (!messagesRef) return;
            if (!confirm("Clear all messages in this room? This cannot be undone.")) return;
            remove(messagesRef);
            document.getElementById("messages").innerHTML = "";
            addSystem("chat cleared");
        };

        // ‚îÄ‚îÄ LEAVE ‚îÄ‚îÄ
        window.leaveChat = function () {
            if (presenceRef) set(presenceRef, null);
            location.reload();
        };

        // ‚îÄ‚îÄ AUTO-DELETE messages older than 24 hours ‚îÄ‚îÄ
        async function cleanupMessages() {
            if (!messagesRef) return;
            try {
                const snap = await get(messagesRef);
                if (!snap.exists()) return;

                const now = Date.now();
                const cutoff = now - MAX_AGE_MS;
                let deleted = 0;

                snap.forEach(child => {
                    const msg = child.val();
                    if (msg.time && msg.time < cutoff) {
                        remove(child.ref);
                        deleted++;
                    }
                });

                if (deleted > 0) {
                    console.log(`[SIGNAL] Cleaned up ${deleted} old messages`);
                    addSystem(`${deleted} old message${deleted > 1 ? "s" : ""} auto-deleted (24h limit)`);
                }
            } catch (e) {
                console.warn("Cleanup error:", e);
            }
        }

        // ‚îÄ‚îÄ PURGE OLDEST messages when over 100 limit ‚îÄ‚îÄ
        async function purgeOldest(count) {
            if (!messagesRef || count <= 0) return;
            try {
                const snap = await get(query(messagesRef, orderByChild("time"), limitToFirst(count)));
                snap.forEach(child => remove(child.ref));
                console.log(`[SIGNAL] Purged ${count} messages (over 100 limit)`);
            } catch (e) {
                console.warn("Purge error:", e);
            }
        }

        // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
        function renderBubble(name, text, type, timestamp) {
            const box = document.getElementById("messages");
            const wrap = document.createElement("div");
            wrap.className = "msg-wrap " + type;

            const time = timestamp
                ? new Date(timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
                : "";

            const meta = document.createElement("div");
            meta.className = "msg-meta";
            meta.textContent = (type === "me" ? "you" : name) + (time ? " ¬∑ " + time : "");

            const bubble = document.createElement("div");
            bubble.className = "bubble";
            bubble.textContent = text;

            wrap.appendChild(meta);
            wrap.appendChild(bubble);
            box.appendChild(wrap);
            box.scrollTop = box.scrollHeight;
        }

        function addSystem(text) {
            const box = document.getElementById("messages");
            const wrap = document.createElement("div");
            wrap.className = "msg-wrap system";
            const b = document.createElement("div");
            b.className = "bubble";
            b.textContent = "‚Äî " + text + " ‚Äî";
            wrap.appendChild(b);
            box.appendChild(wrap);
            box.scrollTop = box.scrollHeight;
        }

        function showErr(msg) {
            const el = document.getElementById("setupError");
            el.textContent = "‚ö† " + msg;
            el.style.display = "block";
        }
    </script>
</body>

</html>